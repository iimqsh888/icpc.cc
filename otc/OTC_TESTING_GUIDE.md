# 🧪 OTC功能测试指南

## 测试环境
- 网络: BSC Mainnet
- OTC合约: `0x9886e955DaD9ABcCC86980E1aC55cA2Ae57D5082`
- CPC代币: `0x5453C25CA8a0aFd9C6e73FF8c8C6Fe299D7F60C9`

---

## 📋 测试前准备

### 1. 准备测试钱包
- ✅ 钱包中有足够的BNB（用于gas和买单）
- ✅ 钱包中有足够的CPC（用于卖单）
- ✅ 建议准备至少 0.01 BNB + 100 CPC

### 2. 打开OTC页面
- 访问: `https://icpc.cc/otc.html` 或本地测试页面
- 连接钱包（MetaMask或其他）

---

## 🧪 测试场景

### 场景1：创建卖单 ✅ 简单

**步骤：**
1. 点击 "SELL" 标签
2. 输入数量：`10` CPC（必须是整数）
3. 输入价格：`0.01` BNB
4. 点击 "Create Order"
5. 第一次会弹出授权请求 → 确认授权
6. 然后弹出创建订单请求 → 确认交易

**预期结果：**
- ✅ 授权成功（授权10亿CPC给OTC合约）
- ✅ 订单创建成功
- ✅ 10 CPC从钱包转入合约
- ✅ 支付0.001 BNB创建费用
- ✅ 订单显示在列表中

**注意事项：**
- CPC数量必须是整数（1, 10, 100等）
- 价格可以是小数（0.01, 0.00123等）

---

### 场景2：创建买单 ✅ 简单

**步骤：**
1. 点击 "BUY" 标签
2. 输入数量：`5` CPC
3. 输入价格：`0.012` BNB
4. 查看总价值：`0.06 BNB`
5. 查看需要支付：`0.061 BNB`（含0.001创建费）
6. 点击 "Create Order"
7. 确认交易

**预期结果：**
- ✅ 订单创建成功
- ✅ 0.061 BNB从钱包转入合约
- ✅ 订单显示在列表中

**注意事项：**
- 确保钱包有足够的BNB
- 总价值 = 数量 × 价格
- 需要支付 = 总价值 + 0.001 BNB

---

### 场景3：成交卖单（买入CPC）✅ 简单

**步骤：**
1. 在订单列表中找到一个卖单（SELL类型）
2. 点击 "Fill" 按钮
3. 确认交易（支付BNB）

**预期结果：**
- ✅ 交易成功
- ✅ 收到CPC代币
- ✅ 支付BNB（含0.2%手续费）
- ✅ 订单状态更新或完成

**注意事项：**
- 不能成交自己的订单
- 需要足够的BNB支付

---

### 场景4：成交买单（卖出CPC）⚠️ 需要授权

**步骤：**
1. 在订单列表中找到一个买单（BUY类型）
2. 点击 "Fill" 按钮
3. **第一次会弹出授权请求** → 确认授权
4. 等待3秒（授权确认中...）
5. 自动弹出成交交易 → 确认交易

**预期结果：**
- ✅ 授权成功（授权10亿CPC）
- ✅ 成交成功
- ✅ CPC从钱包转出
- ✅ 收到BNB（扣除0.2%手续费）
- ✅ 订单状态更新或完成

**注意事项：**
- **首次需要授权CPC代币**
- 授权后等待3秒确保交易确认
- 后续成交不需要再授权
- 不能成交自己的订单

---

### 场景5：取消订单 ✅ 简单

**步骤：**
1. 在 "My Orders" 区域找到自己的订单
2. 点击 "Cancel Order" 按钮
3. 确认取消
4. 确认交易

**预期结果：**
- ✅ 订单取消成功
- ✅ 如果是买单：退回BNB
- ✅ 如果是卖单：退回CPC
- ✅ 订单从列表中移除

---

## ⚠️ 常见问题

### 问题1：授权失败或过期
**错误信息：** "您尚未授权该代币的足够转账额度，或授权已过期"

**原因：**
- 成交买单时需要授权CPC代币
- 授权额度不足
- 授权交易未确认

**解决方案：**
1. 确认授权交易（第一次弹出）
2. 等待3秒让授权确认
3. 如果还是失败，刷新页面重试
4. 检查钱包是否有足够的CPC

---

### 问题2：数量必须是整数
**错误信息：** "Invalid params" 或 "Invalid fill"

**原因：**
- 输入了小数CPC（如0.5, 1.5）
- 合约要求CPC数量必须是整数

**解决方案：**
- 只输入整数：1, 10, 100, 1000等
- 不要输入：0.5, 1.5, 99.9等

---

### 问题3：Gas费用不足
**错误信息：** "Insufficient BNB" 或 "Out of gas"

**原因：**
- 钱包BNB余额不足
- 没有预留gas费用

**解决方案：**
- 确保钱包有额外的0.002-0.003 BNB用于gas
- 创建买单时：需要 (总价值 + 0.001 + 0.003 gas)
- 成交订单时：需要 (支付金额 + 0.002 gas)

---

### 问题4：交易失败
**错误信息：** "Transaction will fail"

**原因：**
- Gas估算失败
- 合约状态变化（订单已被成交）
- 余额不足

**解决方案：**
1. 刷新页面重新加载订单
2. 检查余额是否足够
3. 重新尝试交易

---

## 📊 Gas费用参考

| 操作 | Gas使用量 | 成本(5 Gwei) | 成本(USD) |
|------|----------|--------------|-----------|
| 创建买单 | ~270,000 | 0.00135 BNB | $0.81 |
| 创建卖单 | ~320,000 | 0.00160 BNB | $0.96 |
| 成交订单 | ~80,000 | 0.00040 BNB | $0.24 |
| 取消订单 | ~56,000 | 0.00028 BNB | $0.17 |
| 授权CPC | ~50,000 | 0.00025 BNB | $0.15 |

*假设: BNB = $600, Gas Price = 5 Gwei*

---

## ✅ 测试检查清单

### 基础功能
- [ ] 连接钱包成功
- [ ] 显示钱包地址
- [ ] 显示活跃订单数量
- [ ] 订单列表正常加载

### 创建订单
- [ ] 创建买单成功
- [ ] 创建卖单成功（含授权）
- [ ] 小数点价格正常工作
- [ ] 整数CPC数量验证正常
- [ ] 创建费用0.001 BNB正确扣除

### 成交订单
- [ ] 成交卖单成功（买入CPC）
- [ ] 成交买单成功（卖出CPC，含授权）
- [ ] 授权流程正常（首次）
- [ ] 后续成交无需授权
- [ ] 手续费0.2%正确扣除

### 取消订单
- [ ] 取消买单成功（退回BNB）
- [ ] 取消卖单成功（退回CPC）

### 查询功能
- [ ] 我的订单显示正常
- [ ] 订单状态更新正常
- [ ] 余额显示正确

---

## 🎯 测试建议

### 小额测试
建议先用小额测试：
- 创建订单：1-10 CPC
- 价格：0.001-0.01 BNB
- 总价值：0.001-0.1 BNB

### 完整流程测试
1. 创建1个卖单（10 CPC @ 0.01 BNB）
2. 创建1个买单（5 CPC @ 0.012 BNB）
3. 用另一个钱包成交卖单
4. 用另一个钱包成交买单（测试授权）
5. 取消一个订单

### 压力测试
- 创建多个订单
- 连续成交多个订单
- 测试授权额度消耗

---

## 📞 问题反馈

如果遇到问题：
1. 查看浏览器控制台（F12）的错误信息
2. 查看MetaMask的交易详情
3. 在BSCScan查看交易状态
4. 记录错误信息和操作步骤

---

## 🎉 测试完成

所有功能测试通过后，OTC系统就可以正式使用了！

**重要提醒：**
- ✅ CPC数量必须是整数
- ✅ 成交买单首次需要授权
- ✅ 预留足够的BNB用于gas
- ✅ 小额测试后再进行大额交易
